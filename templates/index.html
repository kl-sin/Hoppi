<!-- /templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hoppi - Your Adventure Awaits!</title>

  <!-- üó∫Ô∏è Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- ============================================================
       üé® HOPPI STYLESHEET ‚Äî MOBILE FIRST + DESKTOP BREAKPOINT
       ============================================================ -->
  <style>
    /* ----------------------------------------------
       üåç RESET & BASE
    ---------------------------------------------- */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      height: 100%;
      font-family: Arial, sans-serif;
      background: #f0f2f5;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 0;
      min-height: 100vh;
    }

    /* ----------------------------------------------
       üß± LAYOUT CONTAINER
    ---------------------------------------------- */
    .container {
      background: #fff;
      width: 100%;
      max-width: 520px;
      padding: 20px 16px;
      margin: 0 auto;
      border-radius: 0;
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      min-height: 100vh;
      box-shadow: none;
      box-sizing: border-box;
    }

    footer {
      margin-top: auto;
      padding: 20px 0;
      text-align: center;
      font-size: 0.9em;
      color: #777;
    }

    /* ----------------------------------------------
       ü™Ñ TYPOGRAPHY & LOGO
    ---------------------------------------------- */
    .logo {
      font-size: 3em;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 1.2em;
    }

    /* ----------------------------------------------
       üîò BUTTONS
    ---------------------------------------------- */
    .btn {
      display: block;
      width: 100%;
      max-width: 400px;
      margin: 10px auto;
      padding: 14px 0;
      border-radius: 12px;
      font-size: 1.05em;
      font-weight: 500;
      text-align: center;
      cursor: pointer;
      background: #667eea;
      color: #fff;
      border: none;
      transition: all 0.3s ease;
    }
    .btn:hover {
      background: #5a6fd8;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: #6c757d;
    }
    .btn-secondary:hover {
      background: #5a6268;
    }

    button.locked {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

    #feedbackButtons .btn {
      width: auto !important;
      display: inline-flex !important;
      justify-content: center;
      align-items: center;
      padding: 10px 20px;
      min-width: 100px;
      margin: 0 10px 10px;
      border-radius: 20px;
      font-size: 1.2em;
      flex: 1;
      max-width: 120px;
    }
    /* ----------------------------------------------
       üìç LOCATION & MAP
    ---------------------------------------------- */
    .location-info {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      display: none;
    }
    .location-info h3 { margin-bottom: 15px; color: #333; }
    #locationStatus { font-weight: bold; margin-bottom: 10px; }

    #getLocationBtn {
      background: #28a745;
      font-size: 1.05em;
      padding: 14px 0;
      width: 100%;
      max-width: 400px;
      margin: 10px auto;
      display: block;
    }
    #getLocationBtn:hover { background: #218838; }

    /* ----------------------------------------------
       üé≤ TASK GENERATOR
    ---------------------------------------------- */
    .task-container {
      background: #e8f4fd;
      padding: 25px;
      border-radius: 15px;
      margin: 20px 0;
      border-left: none;
    }
    .task-text {
      font-size: 1.3em;
      color: #333;
      line-height: 1.6;
      margin-bottom: 20px;
    }

    /* ----------------------------------------------
       üì∏ MEDIA SECTION
    ---------------------------------------------- */
    .upload-section {
      margin: 30px 0;
    }

    .media-type-selector {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      width: 100%;
      max-width: 400px;
      margin: 20px auto;
    }

    .media-type-selector .btn {
      width: 100%;
      margin: 0;
      padding: 12px 0;
      font-size: 1em;
      border-radius: 12px;
    }

    .controls {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    /* ----------------------------------------------
       ü™û STATUS & ALERTS
    ---------------------------------------------- */
    .status {
      margin: 20px 0;
      padding: 15px;
      border-radius: 10px;
      display: none;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .inline-alert {
      margin: 10px auto 15px;
      padding: 10px 16px;
      border-radius: 10px;
      max-width: 90%;
      font-size: 0.95em;
      text-align: center;
      line-height: 1.4;
    }
    .inline-alert.error {
      background: #f8d7da;
      color: #842029;
      border: 1px solid #f5c6cb;
    }
    .inline-alert.success {
      background: #d1e7dd;
      color: #0f5132;
      border: 1px solid #badbcc;
    }

    /* ----------------------------------------------
       ‚è≥ LOADING SPINNER
    ---------------------------------------------- */
    .loading {
      display: none;
      position: relative;
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(4px);
      border-radius: 15px;
      text-align: center;
      padding: 25px 0;
      margin: 15px auto;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .spinner {
      margin: 0 auto 10px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ----------------------------------------------
       üìñ STORY STRIP & MODAL
    ---------------------------------------------- */
    #storyStrip {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 25px;
      margin-top: 20px;
    }
    #storyStrip img {
      width: 100%;
      max-width: 700px;
      border-radius: 16px;
      box-shadow: 0 3px 15px rgba(0,0,0,0.25);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: zoom-in;
    }
    #storyStrip img:hover {
      transform: scale(1.02);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      padding-top: 60px;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background: rgba(0, 0, 0, 0.9);
    }
    .modal img {
      margin: auto;
      display: block;
      max-width: 90%;
      max-height: 85vh;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    #closeModal {
      position: fixed;
      top: 20px;
      right: 35px;
      color: #fff;
      font-size: 2em;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
      z-index: 10000;
    }
    #closeModal:hover { color: #ccc; }

    /* ----------------------------------------------
       üíª DESKTOP BREAKPOINT
    ---------------------------------------------- */
    @media (min-width: 768px) {
      body {
        background: #eef1f6;
        padding: 40px 0;
        justify-content: center;
      }
      .container {
        border-radius: 16px;
        box-shadow: 0 4px 25px rgba(0,0,0,0.1);
        background: #fff;
      }
      .task-container, .upload-section, .location-info {
        border-radius: 12px;
      }
      #storyStrip img {
        max-width: 420px;
        margin: 0 auto;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- ============================================================
         üèÅ HEADER
    ============================================================ -->
    <div class="logo">Hoppi</div>
    <div class="subtitle">üé° Turn the world around you into tiny stories.</div>

    <!-- ============================================================
         üìç LOCATION SECTION
    ============================================================ -->
    <div id="locationInfo" class="location-info">
      <h3>üìç Your Location</h3>
      <p id="locationStatus">‚è≥ Locating...</p>
      <div id="mapContainer" style="display:none;">
        <p id="locationDescription"
           style="font-weight:bold;margin-bottom:10px;color:#333"></p>
        <div id="map"
             style="width:100%;height:300px;border-radius:10px;margin:10px 0;"></div>
      </div>
      <button id="getLocationBtn" class="btn">üìç Get My Location</button>
      <div id="status" class="status"></div>
    </div>

    <div id="locationLoading" class="loading" style="display:none;">
      <div class="spinner"></div>
      <p>Detecting your location...</p>
    </div>

    <!-- ============================================================
         üé≤ TASK GENERATION
    ============================================================ -->
    <div id="taskContainer" class="task-container">
      <h3>ü™Ö Let the day offer you a small surprise.</h3>

      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p style="color:#667eea;font-weight:bold;">
          Generating your adventure task...
        </p>
      </div>

      <div id="taskText" class="task-text"></div>

      <div id="feedbackButtons"
           class="controls"
           style="display:none;justify-content:center;">
        <button id="thumbUpBtn" class="btn btn-secondary">üëç</button>
        <button id="thumbDownBtn" class="btn btn-secondary">üëé</button>
      </div>

      <div id="thumbDownReason" style="display:none;margin-top:10px;">
        <textarea id="feedbackReason"
                  placeholder="What didn‚Äôt work?"
                  rows="3"
                  style="width:100%;border-radius:8px;padding:10px;border:1px solid #ccc"></textarea>
        <button id="submitFeedbackBtn"
                class="btn btn-secondary"
                style="margin-top:8px;">Submit Feedback</button>
      </div>

      <button id="newTaskBtn" class="btn">Get New Task</button>
      <div id="feedbackStatus"
           class="status"
           style="display:none;margin-bottom:10px;"></div>
    </div>

    <!-- ============================================================
         üé• MEDIA CAPTURE / UPLOAD SECTION
    ============================================================ -->
    <div id="uploadSection" class="upload-section">
      <h3>ü™Ñ Capture this tiny moment</h3>

      <div id="captureAlert" class="inline-alert" style="display:none;"></div>

      <!-- Media type selector -->
      <div class="media-type-selector">
        <button id="photoBtn" class="btn btn-secondary">üì∑ Photo</button>
        <button id="videoBtn" class="btn btn-secondary">üìπ Video</button>
        <button id="audioBtn" class="btn btn-secondary">üé§ Audio</button>
        <button id="textBtn" class="btn btn-secondary">üìù Text</button>
      </div>

      <p id="countdownTimer"
         style="font-size:1.2em;color:#667eea;font-weight:bold;display:none;">
         ‚è≥ 30s left
      </p>

      <!-- üì∏ Photo capture -->
      <div id="photoCaptureSection"
           style="display:block;text-align:center;margin:20px 0;">
        <video id="photoPreview"
               autoplay playsinline muted
               width="100%" height="300"
               style="border-radius:10px;display:none;object-fit:cover;"></video>
        <canvas id="photoCanvas"
                width="640" height="480"
                style="display:none;border-radius:10px;margin-top:10px;max-width:100%;max-height:300px;object-fit:cover;"></canvas>
        <div class="controls" style="margin-bottom:15px;">
          <button id="startPhotoBtn" class="btn">üì∑ Start Photo</button>
          <button id="capturePhotoBtn"
                  class="btn btn-secondary"
                  style="display:none;">üì∏ Capture</button>
          <button id="closePhotoBtn"
                  class="btn btn-secondary"
                  style="display:none;">‚èπÔ∏è Stop</button>
        </div>
      </div>

      <!-- üé¨ Video recording -->
      <div id="videoSection" style="display:none;text-align:center;margin:20px 0;">
        <div class="controls" style="margin-bottom:15px;">
          <button id="startVideoBtn" class="btn">üé¨ Start Recording</button>
          <button id="stopVideoBtn"
                  class="btn btn-secondary"
                  style="display:none;">‚èπÔ∏è Stop Recording</button>
        </div>
        <video id="videoPreview"
               width="100%" height="300"
               autoplay playsinline muted
               style="border-radius:10px;display:none;"></video>
      </div>

      <!-- üé§ Audio recording -->
      <div id="audioSection" style="display:none;">
        <div class="controls" style="text-align:center;margin:20px 0;">
          <button id="startAudioBtn" class="btn">üé§ Start Recording</button>
          <button id="stopAudioBtn"
                  class="btn btn-secondary"
                  style="display:none;">‚èπÔ∏è Stop Recording</button>
        </div>
        <audio id="audioPreview"
               controls
               style="width:100%;margin:10px 0;display:none;"></audio>
      </div>

      <!-- üìù Text entry -->
      <div id="textSection"
           style="display:none;text-align:center;margin:20px 0;">
        <textarea id="textInput"
                  placeholder="Write your thoughts here (max 300 characters)‚Ä¶"
                  rows="6"
                  style="width:100%;border-radius:10px;padding:10px;border:1px solid #ccc;"></textarea>
        <p id="wordCount" style="color:#666;margin-top:5px;">0 / 300 characters</p>
      </div>

      <!-- Preview + actions -->
      <div id="mediaPreview"></div>
      <div id="mediaError" class="inline-alert error" style="display:none;"></div>

      <div id="submitLoading" class="loading" style="display:none;">
        <div class="spinner"></div>
        <p style="color:#667eea;font-weight:bold;">Your moment‚Äôs being felt...</p>
      </div>
      <div id="submitAnswer" class="status" style="display:none;"></div>

      <!-- After-submit new task -->
      <div id="newTaskAfterSubmit" style="display:none;margin-top:10px;">
        <button id="genNewTaskBtn" class="btn">‚ú® New Task</button>
      </div>

      <!-- Action buttons -->
      <div id="actionButtons" style="display:none;">
        <button id="submitBtn" class="btn">üì§ Submit</button>
        <button id="deleteBtn" class="btn btn-secondary">üóë Delete</button>
        <button id="downloadBtn" class="btn btn-secondary">üíæ Download</button>
      </div>

      <!-- üìñ Story / Progress -->
      <div id="storySection"
           style="display:none;text-align:center;margin-top:30px;">
        <h3>üñå Your Hoppi Story Unfolds!</h3>
        <p id="storyText"
           style="font-size:1.1em;color:#555;margin:10px 0;"></p>
        <div id="storyStrip"
             style="display:flex;gap:10px;overflow-x:auto;justify-content:center;margin-top:15px;"></div>
        <button id="revealStoryBtn"
                class="btn"
                style="margin-top:15px;">‚ú® Reveal My Story</button>
      </div>
    </div>

    <!-- ============================================================
         ‚öôÔ∏è FOOTER
    ============================================================ -->
    <footer>¬© All rights reserved by Sinko</footer>
  </div>

  <!-- ============================================================
       üñºÔ∏è IMAGE MODAL (for zoomed story/media)
  ============================================================ -->
  <div id="imageModal" class="modal">
    <span id="closeModal">&times;</span>
    <img id="modalImage" src="" alt="Preview" />
  </div>


  <script>
    // --- state ---
    let currentLocation=null,currentTask=null,uploadedMedia=null,currentMediaType='photo';
    let mediaRecorder=null,recordedChunks=[],videoStream=null,audioStream=null,photoStream=null;
    let map=null,locationMarker=null,suppressOnStop=false,countdownInterval=null,videoTimer=null,audioTimer=null;
    let countdownSeconds=30,textDraft=''; let taskAborter=null;
    let taskMarker=null;

    // UI helpers
    const $ = id => document.getElementById(id);
    const show = (el,flag) => el.style.display = flag ? 'block' : 'none';

    // Media error helpers (errors only)
    function showMediaError(msg){
      const el=$('mediaError');
      el.textContent = msg;
      el.style.display = 'block';
      console.error('[MEDIA]', msg);
    }
    function clearMediaError(){
      const el=$('mediaError');
      el.textContent = '';
      el.style.display = 'none';
    }

    function initializeStoryProgress() {
  const count = getCompletedCount();
  const storiesUnlocked = Math.floor(count / 3);
  const nextUnlockAt = (storiesUnlocked + 1) * 3;
  const remaining = nextUnlockAt - count;

  const storySec = $('storySection');
  const storyText = $('storyText');
  const storyStrip = $('storyStrip');
  const revealBtn = $('revealStoryBtn');

  show(storySec, true);
  show(revealBtn, false); // hide reveal button permanently

  // üß† If not yet at 3, 6, 9... show teaser message only
  if (count < 3 || count % 3 !== 0) {
    storyText.textContent =
      count < 3
        ? `‚ú® Complete ${remaining} more task${remaining > 1 ? 's' : ''} to unlock your first story!`
        : `‚ú® Complete ${remaining} more task${remaining > 1 ? 's' : ''} to unlock your next story!`;
    storyStrip.innerHTML = '';
    return;
  }

  // üéâ If count is multiple of 3, show the story!
  const storedText = localStorage.getItem('hoppi_story_pending_text');
  const storedImages = localStorage.getItem('hoppi_story_pending_images');

  storyText.textContent = storedText
    ? storedText
    : `üìñ You've unlocked ${storiesUnlocked} story part${storiesUnlocked > 1 ? 's' : ''}!`;

  storyStrip.innerHTML = '';
  if (storedImages) {
    JSON.parse(storedImages).forEach(scene => {
      const img = document.createElement('img');
      img.src = scene.url;
      img.alt = scene.title || '';
      img.style.borderRadius = '12px';
      img.style.width = '180px';
      img.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
      storyStrip.appendChild(img);
    });
  }
}

    // Subtle success cue
    function flashPreview(elId){
      const el = $(elId);
      if(!el) return;
      const prevOutline = el.style.outline;
      el.style.outline = '3px solid #d1e7dd';
      setTimeout(()=>{ el.style.outline = prevOutline || ''; }, 600);
    }

    function startCountdown(duration=30){
      const t=$('countdownTimer'); countdownSeconds=duration; t.textContent=`‚è≥ ${countdownSeconds}s left`; show(t,true);
      clearInterval(countdownInterval);
      countdownInterval=setInterval(()=>{ countdownSeconds--;
        if(countdownSeconds>0){ t.textContent=`‚è≥ ${countdownSeconds}s left`; }
        else{ stopCountdown(); t.textContent='‚úÖ Done!'; setTimeout(()=>show(t,false),1500); }
      },1000);
    }
    function stopCountdown(){ clearInterval(countdownInterval); show($('countdownTimer'),false); }

    function resetCapture(isSwitching=true){
      const wasRecording = mediaRecorder && mediaRecorder.state==='recording';
      suppressOnStop = isSwitching && wasRecording;
      if(wasRecording){ try{ mediaRecorder.stop(); }catch{} }
      [videoStream,audioStream,photoStream].forEach(s=>{ if(s){ s.getTracks().forEach(t=>t.stop()); }});
      videoStream=audioStream=photoStream=null;
      ['photoPreview','photoCanvas','videoPreview','audioPreview'].forEach(id=>{ const el=$(id); if(el) show(el,false);});
      ['capturePhotoBtn','closePhotoBtn','stopVideoBtn','stopAudioBtn'].forEach(id=>{ const el=$(id); if(el) show(el,false);});
      if(isSwitching){ $('mediaPreview').innerHTML=''; show($('actionButtons'),false); uploadedMedia=null; }
      stopCountdown();
      clearTimeout(videoTimer); clearTimeout(audioTimer);
      clearMediaError();
      // clear submit area when switching types
      show($('submitLoading'),false);
      const ans=$('submitAnswer'); ans.textContent=''; ans.className='status'; show(ans,false);
    }

    const blueIcon = new L.Icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
      shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});
    const redIcon = new L.Icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
      shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});

    function getLocation(){
      const status=$('locationStatus'), info=$('locationInfo');
      if(!navigator.geolocation){ status.textContent="‚ùå Geolocation is not supported by this browser."; showStatus('Geolocation is not supported by this browser.','error'); return;}
      status.textContent="‚è≥ Locating..."; info.style.display='block';
      navigator.geolocation.getCurrentPosition(pos=>{
        currentLocation={latitude:pos.coords.latitude,longitude:pos.coords.longitude,accuracy:pos.coords.accuracy};
        status.style.display='none'; showMapAndLocation(); showStatus('Location detected successfully!','success');
      },err=>{
        const msgs={1:'Permission denied.',2:'Position unavailable.',3:'Request timed out.'};
        const msg=`‚ùå Unable to detect location. ${msgs[err.code]||'Unknown error.'}`;
        status.textContent=msg; status.style.display='block'; showStatus(msg,'error');
      },{enableHighAccuracy:true,timeout:10000,maximumAge:300000});
    }

    function showMapAndLocation(){
      const mapContainer=$('mapContainer'); mapContainer.style.display='block';
      if(map) map.remove();

      map=L.map('map').setView([currentLocation.latitude,currentLocation.longitude],15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap contributors'}).addTo(map);
      locationMarker=L.marker([currentLocation.latitude,currentLocation.longitude],{icon:blueIcon}).addTo(map);
      getLocationDescription();

      setTimeout(() => {
        if(!map) return;
        map.invalidateSize();
        map.panTo([currentLocation.latitude,currentLocation.longitude]);
        if (currentTask && currentTask.selected_place &&
            currentTask.selected_place.lat != null && currentTask.selected_place.lon != null) {
          renderTaskTarget(currentTask.selected_place);
        }
      }, 500);
    }

    async function getLocationDescription(){
      try{
        const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${currentLocation.latitude}&lon=${currentLocation.longitude}&addressdetails=1`,{headers:{'User-Agent':'hoppi-app'}});
        const data=await r.json();
        let description="Hey, you're somewhere interesting! What are you up to?";
        let popup=`üìç You are at ${currentLocation.latitude.toFixed(4)}, ${currentLocation.longitude.toFixed(4)}`;
        if(data && data.address){
          const a=data.address;
          const road=a.road||a.pedestrian||a.path||null;
          const neighborhood=a.neighbourhood||a.suburb||a.city||a.town||a.village||null;
          const fields=[a.amenity,a.leisure,a.shop,a.tourism,a.highway,a.office,a.building,a.natural,a.landuse].filter(Boolean).map(v=>v.toLowerCase());
          const has=k=>fields.includes(k);
          let type=null;
          if(['park','garden','playground','trail','forest','woodland'].some(has)) type='park';
          else if(['museum','gallery','exhibition'].some(has)) type='museum';
          else if(['restaurant','cafe','bar'].some(has)) type='restaurant';
          else if(['mall','shopping','market','retail','store','shop'].some(has)) type='mall';

          if(type){ description=`Hey, you are in a ${type}. Let‚Äôs see what‚Äôs waiting to be noticed.`; popup=`üìç You are in a ${type}`; }
          else if(road){ description=`Hey, you are on ${road}. Let‚Äôs see what‚Äôs waiting to be noticed.`; popup=`üìç You are on ${road}`; }
          else if(neighborhood){ description=`Hey, you are near ${neighborhood}. Let‚Äôs see what‚Äôs waiting to be noticed.`; popup=`üìç You are near ${neighborhood}`; }
        }
        $('locationDescription').textContent=description;
        if(locationMarker){ locationMarker.bindPopup(popup).openPopup(); }
      }catch{
        $('locationDescription').textContent="üìç Hey, you are here! Let‚Äôs see what‚Äôs waiting to be noticed.";
        if(locationMarker){ locationMarker.bindPopup("üìç You are here!").openPopup(); }
      }
    }

    // Helpers for task target
    function escapeHtml(s=''){
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
    }
    function getCategoryEmoji(cat){
      const c=(cat||'').toLowerCase();
      if(c.includes('cafe')) return '‚òï';
      if(c.includes('restaurant')||c.includes('fast_food')||c.includes('food')) return 'üçΩÔ∏è';
      if(c.includes('park')||c.includes('garden')||c.includes('playground')) return 'üå≥';
      if(c.includes('library')) return 'üìö';
      if(c.includes('mall')||c.includes('retail')||c.includes('market')) return 'üè¨';
      if(c.includes('supermarket')||c.includes('convenience')) return 'üõí';
      if(c.includes('bar')||c.includes('pub')) return 'üç∫';
      if(c.includes('museum')||c.includes('gallery')) return 'üèõÔ∏è';
      if(c.includes('hotel')) return 'üè®';
      if(c.includes('hospital')||c.includes('clinic')) return 'üè•';
      if(c.includes('school')||c.includes('university')) return 'üéì';
      return 'üìç';
    }
    function clearTaskTarget(){
      if(taskMarker){ map && map.removeLayer(taskMarker); taskMarker=null; }
    }
    function renderTaskTarget(place){
      if(!map || !place || place.lat==null || place.lon==null || !currentLocation) return;
      clearTaskTarget();
      const userLL  = L.latLng(currentLocation.latitude, currentLocation.longitude);
      const placeLL = L.latLng(place.lat, place.lon);
      const emoji = getCategoryEmoji(place.category);
      const name  = place.name || 'Task location';
      const label = `${emoji} ${escapeHtml(name)}`;
      const gMaps = `https://www.google.com/maps?q=${place.lat},${place.lon}`;
      const aMaps = `https://maps.apple.com/?q=${place.lat},${place.lon}`;

      taskMarker = L.marker([place.lat, place.lon], { icon: redIcon })
        .addTo(map)
        .bindPopup(
          `
          <div style="font-weight:600;">${label}</div>
          <div style="font-size:12px;color:#555;margin-top:6px;">
            <a href="${gMaps}" target="_blank" rel="noopener">Open in Google Maps</a>
            &nbsp;¬∑&nbsp;
            <a href="${aMaps}" target="_blank" rel="noopener">Apple Maps</a>
          </div>
          `,
          { autoClose:false, closeOnClick:false }
        )
        .openPopup();

      const bounds = L.latLngBounds([userLL, placeLL]).pad(0.25);
      map.fitBounds(bounds,{maxZoom:16});
    }

    async function generateTask(){
      if(!currentLocation){ showStatus('üìç Please allow location first before generating a task.','error'); return; }
      if(taskAborter) taskAborter.abort();
      resetCapture(true);
      $('mediaPreview').innerHTML = '';
      show($('actionButtons'), false);
      show($('submitLoading'), false);
      const ans = $('submitAnswer');
      ans.textContent = '';
      ans.className = 'status';
      show(ans, false);
      $('submitBtn').style.display = 'inline-block'; // ‚úÖ Re-enable Submit for new task

      textDraft = '';
      $('textInput').value = '';
      $('wordCount').textContent = '0 / 300 characters';
      uploadedMedia = null;

      taskAborter = new AbortController();
      showLoading(true);

      try{
        const res=await fetch('/generate-task',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(currentLocation),signal:taskAborter.signal});
        const data=await res.json();
        if(res.ok){
          currentTask=data;

          show($('feedbackButtons'), true);
          show($('thumbDownReason'), false);

          if (data && data.selected_place && data.selected_place.lat != null && data.selected_place.lon != null) {
          renderTaskTarget(data.selected_place);

          // üß≠ Center the map on the red pin and open its popup
          if (map) {
            map.setView([data.selected_place.lat, data.selected_place.lon], 16, {animate: true});
            setTimeout(() => {
              if (taskMarker) taskMarker.openPopup();
            }, 500);
          }
        } else {
          clearTaskTarget();
        }

          ['photoBtn','videoBtn','audioBtn','textBtn'].forEach(id=>$(id).classList.remove('locked'));
          currentMediaType='photo';
          show($('photoCaptureSection'),true); show($('startPhotoBtn'),true);
          show($('videoSection'),false); show($('audioSection'),false); show($('textSection'),false);
          $('photoBtn').className='btn'; $('videoBtn').className='btn btn-secondary'; $('audioBtn').className='btn btn-secondary'; $('textBtn').className='btn btn-secondary';
          clearCaptureAlert(); $('taskText').textContent=data.task; show($('taskContainer'),true); show($('uploadSection'),true);
          $('taskText').textContent = data.task;

          // üëá Add this below
          show($('feedbackButtons'), true);
          show($('thumbDownReason'), false);

          showTaskStatus(`üéØ Task generated for ${data.location_type} location!`, 'success');
          // $('uploadSection').scrollIntoView({behavior:'smooth',block:'center'}); 
          restoreMapIfHidden();
        }else{ showStatus(data.error||'Failed to generate task','error'); }
      }catch(e){ if(e.name!=='AbortError') showStatus('Error generating task: '+e.message,'error'); }
      finally{ showLoading(false); }
    }

    function showLoading(showIt){
      const d=$('loading'), p=d.querySelector('p');
      const msgs=["üëÄ Looking for something you might‚Äôve missed...",
      "üå• Listening to what the day wants to show you...",
      "üìç Placing you gently in your next tiny story...",
      "üïµÔ∏è Finding a small mystery near you...",
      "üîÆ Let‚Äôs ask the world for a new little moment..."];
      if(showIt){ p.textContent=msgs[Math.floor(Math.random()*msgs.length)]; show(d,true); } else { show(d,false); restoreMapIfHidden(); }
    }
    function showStatus(message,type){ const s=$('status'); s.textContent=message; s.className=`status ${type}`; show(s,true); setTimeout(()=>show(s,false),5000); }
    function showTaskStatus(message, type) {
      const s = $('feedbackStatus');
      s.textContent = message;
      s.className = `status ${type}`;
      show(s, true);

      // Auto-hide after a few seconds
      setTimeout(() => {
        show(s, false);
      }, 5000);
    }
    function showCaptureAlert(msg,type='error'){ const el=$('captureAlert'); el.className=`inline-alert ${type}`; el.textContent=msg; show(el,true); el.scrollIntoView({behavior:'smooth',block:'center'}); }
    function clearCaptureAlert(){ const el=$('captureAlert'); show(el,false); el.textContent=''; el.className='inline-alert'; }
    function checkTaskBeforeRecording(){ if(!currentTask||!currentTask.task){ showCaptureAlert('‚ö†Ô∏è Please generate a task before capturing your moment!'); return false;} clearCaptureAlert(); return true; }

    function setMediaType(type){
      currentMediaType=type;
      if(!currentTask||!currentTask.task){
        showCaptureAlert('‚ö†Ô∏è Please generate a task before capturing your moment!','error');
        ['photoCaptureSection','videoSection','audioSection','textSection'].forEach(id=>show($(id),false));
        return;
      }
      clearCaptureAlert();
      ['photo','video','audio','text'].forEach(bt=>{ $(`${bt}Btn`).className = (type===bt)?'btn':'btn btn-secondary';});
      ['photoCaptureSection','videoSection','audioSection','textSection'].forEach(id=>show($(id),false));
      resetCapture(true);
      if(type==='photo'){ show($('photoCaptureSection'),true); show($('startPhotoBtn'),true); }
      else if(type==='video'){ show($('videoSection'),true); show($('startVideoBtn'),true); }
      else if(type==='audio'){ show($('audioSection'),true); show($('startAudioBtn'),true); }
      else if(type==='text'){ show($('textSection'),true); restoreTextFromDraft(); }
      ['startPhotoBtn','startVideoBtn','startAudioBtn'].forEach(id=>{ if(type==='text') show($(id),false);});
      restoreMapIfHidden();
    }

    function restoreTextFromDraft(){
      const ta=$('textInput'), ab=$('actionButtons'), wc=$('wordCount');
      ta.value=textDraft; const len=textDraft.length; wc.textContent=`${Math.min(len,300)} / 300 characters`;
      if(len>0){ uploadedMedia=new Blob([textDraft],{type:'text/plain'}); show(ab,true);} else { uploadedMedia=null; show(ab,false); }
    }

    function setupMediaUpload(){ /* reserved for manual uploads */ }

    function safeRecorder(stream, fallbackTypes){
  for(const t of fallbackTypes){
    if(MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(t)){
      try{ return new MediaRecorder(stream,{mimeType:t}); }catch{}
    }
  }
  return new MediaRecorder(stream);
}

// ‚úÖ Add this helper here (keep just one copy of safeRecorder above)
async function getRearCameraStream(withAudio = false) {
  const constraints = {
    video: { facingMode: { exact: "environment" } },
    audio: withAudio
  };
  try {
    return await navigator.mediaDevices.getUserMedia(constraints);
  } catch (e) {
    console.warn("Rear camera not available, falling back to default", e);
    return await navigator.mediaDevices.getUserMedia({ video: true, audio: withAudio });
  }
}

    async function startVideoRecording(){
      if(!checkTaskBeforeRecording()) return;
      suppressOnStop=false; recordedChunks=[]; $('mediaPreview').innerHTML=''; show($('actionButtons'),false); clearMediaError();
      try{
        videoStream = await getRearCameraStream(true);
        const vp=$('videoPreview'); vp.srcObject=videoStream; show(vp,true);
        mediaRecorder = safeRecorder(videoStream, ['video/webm;codecs=vp9,opus','video/webm;codecs=vp8,opus','video/mp4']);
        mediaRecorder.ondataavailable=e=>{ if(e.data.size>0) recordedChunks.push(e.data); };
        mediaRecorder.onstop=()=>{ if(suppressOnStop){suppressOnStop=false;return;}
          const blob=new Blob(recordedChunks,{type: recordedChunks[0]?.type || 'video/webm'}); if(blob.size===0) return;
          const url=URL.createObjectURL(blob);
          const v=document.createElement('video'); v.src=url; v.controls=true; v.style.width='100%'; v.style.maxHeight='300px'; v.style.borderRadius='10px';
          const mp=$('mediaPreview'); mp.innerHTML=''; mp.appendChild(v); 
          show($('actionButtons'),true); 
          $('submitBtn').style.display = 'inline-block'; // ‚úÖ Re-show submit
          uploadedMedia=blob;
          flashPreview('videoPreview');
          setTimeout(()=>mp.scrollIntoView({behavior:'smooth',block:'center'}),300);
          v.onloadeddata=()=>URL.revokeObjectURL(url);
        };
        mediaRecorder.start(); startCountdown(30); show($('startVideoBtn'),false); show($('stopVideoBtn'),true);
        videoTimer=setTimeout(()=>{ if(mediaRecorder&&mediaRecorder.state==='recording') stopVideoRecording(); },30000);
      }catch(e){ showMediaError('Error accessing camera/mic: '+(e?.message||e)); }
      finally{ restoreMapIfHidden(); }
    }
    function stopVideoRecording(){
      const vp=$('videoPreview');
      if(mediaRecorder && mediaRecorder.state==='recording'){ stopCountdown(); try{mediaRecorder.stop();}catch{} }
      if(videoStream){ videoStream.getTracks().forEach(t=>t.stop()); videoStream=null; }
      show(vp,false); show($('startVideoBtn'),true); show($('stopVideoBtn'),false);
    }

    async function startAudioRecording(){
      if(!checkTaskBeforeRecording()) return;
      suppressOnStop=false; recordedChunks=[]; $('mediaPreview').innerHTML=''; show($('actionButtons'),false); clearMediaError();
      try{
        audioStream=await navigator.mediaDevices.getUserMedia({audio:true});
        mediaRecorder = safeRecorder(audioStream, ['audio/webm;codecs=opus','audio/ogg;codecs=opus']);
        mediaRecorder.ondataavailable=e=>{ if(e.data.size>0) recordedChunks.push(e.data); };
        mediaRecorder.onstop=()=>{ if(suppressOnStop){suppressOnStop=false;return;}
          const blob=new Blob(recordedChunks,{type: recordedChunks[0]?.type || 'audio/webm'}); if(blob.size===0) return;
          const url=URL.createObjectURL(blob);
          const a=document.createElement('audio'); a.src=url; a.controls=true; a.style.width='100%';
          const mp=$('mediaPreview'); mp.innerHTML=''; mp.appendChild(a); 
          show($('actionButtons'),true); 
          $('submitBtn').style.display = 'inline-block'; // ‚úÖ Re-show submit
          uploadedMedia=blob;
          flashPreview('audioPreview');
          setTimeout(()=>mp.scrollIntoView({behavior:'smooth',block:'center'}),300);
          a.onloadeddata=()=>URL.revokeObjectURL(url);
        };
        mediaRecorder.start(); startCountdown(30); show($('startAudioBtn'),false); show($('stopAudioBtn'),true);
        audioTimer=setTimeout(()=>{ if(mediaRecorder&&mediaRecorder.state==='recording') stopAudioRecording(); },30000);
      }catch(e){ showMediaError('Error accessing microphone: '+(e?.message||e)); }
    }
    function stopAudioRecording(){
      if(mediaRecorder && mediaRecorder.state==='recording'){ stopCountdown(); try{mediaRecorder.stop();}catch{} }
      if(audioStream){ audioStream.getTracks().forEach(t=>t.stop()); audioStream=null; }
      show($('startAudioBtn'),true); show($('stopAudioBtn'),false);
    }

    function getTimestamp(){ const n=new Date(); const pad=n=>n.toString().padStart(2,'0'); return `${n.getFullYear()}-${pad(n.getMonth()+1)}-${pad(n.getDate())}_${pad(n.getHours())}-${pad(n.getMinutes())}-${pad(n.getSeconds())}`; }

    $('startPhotoBtn').addEventListener('click', async ()=>{
      if(!checkTaskBeforeRecording()) return;
      try{
        clearMediaError();
        photoStream = await getRearCameraStream(false);
        const v=$('photoPreview'); v.srcObject=photoStream; show(v,true); show($('photoCanvas'),false);
        show($('startPhotoBtn'),false); show($('capturePhotoBtn'),true); show($('closePhotoBtn'),true);
        v.scrollIntoView({behavior:'smooth',block:'center'});
      }catch(err){ showMediaError('Unable to access camera: '+(err?.message||err)); } finally{ restoreMapIfHidden(); }
    });

    $('capturePhotoBtn').addEventListener('click', ()=>{
      const v=$('photoPreview'), c=$('photoCanvas'), ctx=c.getContext('2d');
      const r=v.getBoundingClientRect(); c.width=r.width; c.height=r.height;
      const av=v.videoWidth/v.videoHeight, ad=r.width/r.height;
      let sx=0,sy=0,sw=v.videoWidth,sh=v.videoHeight;
      if(av>ad){ const nw=v.videoHeight*ad; sx=(v.videoWidth-nw)/2; sw=nw; } else if(av<ad){ const nh=v.videoWidth/ad; sy=(v.videoHeight-nh)/2; sh=nh; }
      ctx.drawImage(v,sx,sy,sw,sh,0,0,c.width,c.height);
      if(photoStream){ photoStream.getTracks().forEach(t=>t.stop()); photoStream=null; }
      show(v,false); show($('capturePhotoBtn'),false); show($('closePhotoBtn'),false);
      c.toBlob(blob=>{
        uploadedMedia=blob;
        const url=URL.createObjectURL(blob);
        const img=new Image(); img.src=url; img.style.display='block'; img.style.margin='10px auto'; img.style.borderRadius='10px'; img.style.maxWidth='100%'; img.style.maxHeight='300px'; img.style.boxShadow='0 2px 10px rgba(0,0,0,.2)';
        const mp=$('mediaPreview'); mp.innerHTML=''; mp.appendChild(img); 
        show($('actionButtons'), true);
        $('submitBtn').style.display = 'inline-block'; // ‚úÖ Re-show submit
        flashPreview('photoCanvas');
        setTimeout(()=>mp.scrollIntoView({behavior:'smooth',block:'center'}),300);
        img.onload=()=>URL.revokeObjectURL(url);
      },'image/jpeg');
    });

    $('closePhotoBtn').addEventListener('click', ()=>{
      if(photoStream){ photoStream.getTracks().forEach(t=>t.stop()); photoStream=null; }
      show($('photoPreview'),false); show($('photoCanvas'),false); show($('startPhotoBtn'),true); show($('capturePhotoBtn'),false); show($('closePhotoBtn'),false);
      restoreMapIfHidden();
    });

    function downloadMedia(){
      if(!uploadedMedia) return;
      const link=document.createElement('a');
      let extMap={photo:'jpg',video:'webm',audio:'webm',text:'txt'};
      const ext=extMap[currentMediaType]||'dat';
      const url=URL.createObjectURL(uploadedMedia);
      link.href=url; link.download=`hoppi-${currentMediaType}-${getTimestamp()}.${ext}`;
      document.body.appendChild(link); link.click(); document.body.removeChild(link);
      setTimeout(()=>URL.revokeObjectURL(url),0);
    }

    function deleteMedia(){
      const mp=$('mediaPreview'), ab=$('actionButtons'), mi=$('mediaInput');
      mp.innerHTML=''; 
      show(ab,false); 
      uploadedMedia=null; 
      if(mi) mi.value='';
      if(currentMediaType==='photo'){ show($('photoPreview'),false); show($('photoCanvas'),false); show($('startPhotoBtn'),true); show($('capturePhotoBtn'),false); show($('closePhotoBtn'),false); }
      else if(currentMediaType==='video'){ show($('videoPreview'),false); show($('startVideoBtn'),true); show($('stopVideoBtn'),false); }
      else if(currentMediaType==='audio'){ show($('audioPreview'),false); show($('startAudioBtn'),true); show($('stopAudioBtn'),false); }
      else if(currentMediaType==='text'){ textDraft=''; $('textInput').value=''; $('wordCount').textContent='0 / 300 characters'; }
      // clear previous submit result when deleting media
      show($('submitLoading'),false);
      const ans=$('submitAnswer'); ans.textContent=''; ans.className='status'; show(ans,false);
    }

    // Submit area helpers
    function setSubmitAnswer(text, kind='success'){
      const ans=$('submitAnswer');
      ans.textContent = text;
      ans.className = `status ${kind}`;
      show(ans,true);
      ans.scrollIntoView({behavior:'smooth',block:'nearest'});
    }

    function getCompletedCount() {
      return parseInt(localStorage.getItem('hoppi_completed_count') || '0', 10);
    }

    function incrementCompletedCount() {
      const count = getCompletedCount() + 1;
      localStorage.setItem('hoppi_completed_count', count);
      return count;
    }

    function resetCompletedCount() {
      localStorage.removeItem('hoppi_completed_count');
    }

    // Submit with judge (expects /submit backend)
    function getOrCreateSessionId(){
      const KEY='hoppi_session_id'; let id=localStorage.getItem(KEY);
      if(!id){ id=([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16)); localStorage.setItem(KEY,id);}
      return id;
    }
    async function submitMedia(){
      if(!currentTask||!currentTask.task){ showCaptureAlert('‚ö†Ô∏è Please generate a task before submitting!','error'); return; }
      if(currentMediaType!=='text' && !uploadedMedia){ showCaptureAlert('‚ö†Ô∏è Record or upload something first.','error'); return; }

      // reset submit UI
      const ans=$('submitAnswer'); ans.textContent=''; ans.className='status'; show(ans,false);
      show($('submitLoading'),true);

      const fd=new FormData();
      fd.append('session_id',getOrCreateSessionId());
      fd.append('task',currentTask.task);
      fd.append('media_type',currentMediaType);
      if(currentLocation){ fd.append('lat',String(currentLocation.latitude)); fd.append('lon',String(currentLocation.longitude)); }
      if(currentMediaType==='text'){ fd.append('text',typeof textDraft==='string'?textDraft:$('textInput').value||''); }
      else{
        const ext=currentMediaType==='photo'?'jpg':'webm';
        const file=new File([uploadedMedia],`submission-${getTimestamp()}.${ext}`,{type: uploadedMedia.type || (currentMediaType==='photo'?'image/jpeg':'video/webm')});
        fd.append('file',file);
      }

      try{
        const res=await fetch('/submit',{method:'POST',body:fd});
        const data=await res.json();
        if(!res.ok||!data.ok){ throw new Error(data.error||'Submit failed'); }
        setSubmitAnswer(data.judge_text,'success');
        
        // üßπ Hide submit button to prevent duplicate submission
        $('submitBtn').style.display = 'none';

        $('newTaskAfterSubmit').style.display = 'block';
        
        
        // üåü Show Guardian Surprise if ready
        if (data.story_ready && data.story_images && data.story_text) {
  // Save story content for later chapters (even if not yet unlocked)
  localStorage.setItem('hoppi_story_pending_text', data.story_text);
  localStorage.setItem('hoppi_story_pending_images', JSON.stringify(data.story_images));
}

      // ‚úÖ Increment progress and unlock story after 3 submissions
      const newCount = incrementCompletedCount();
      console.log("‚úÖ Completed count:", newCount);

      // --- Progressive story unlock ---
      // --- Progressive story unlock (auto-show) ---
const unlockedBefore = Math.floor((newCount - 1) / 3);
const unlockedNow = Math.floor(newCount / 3);

const storySec = $('storySection');
const storyText = $('storyText');
const storyStrip = $('storyStrip');
const revealBtn = $('revealStoryBtn');

show(storySec, true);
show(revealBtn, false); // we no longer use it

if (newCount % 3 === 0) {
  // üéâ Auto-display story content
  const storedText = localStorage.getItem('hoppi_story_pending_text');
  const storedImages = localStorage.getItem('hoppi_story_pending_images');

  storyText.textContent = storedText
    ? storedText
    : `‚ú® Chapter ${unlockedNow} unlocked! ${unlockedNow * 3} tasks completed.`;

  storyStrip.innerHTML = '';
  if (storedImages) {
    JSON.parse(storedImages).forEach(scene => {
      const img = document.createElement('img');
      img.src = scene.url;
      img.alt = scene.title || '';
      img.style.borderRadius = '12px';
      img.style.width = '180px';
      img.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
      storyStrip.appendChild(img);
    });
  }

  storyStrip.style.display = 'flex';
  storyStrip.scrollIntoView({ behavior: 'smooth', block: 'center' });
} else {
  // üïì Not yet unlocked ‚Äî show motivational message
  const nextUnlockAt = (unlockedNow + 1) * 3;
  const remaining = nextUnlockAt - newCount;
  storyText.textContent = `‚ú® Complete ${remaining} more task${remaining > 1 ? 's' : ''} to unlock your next story!`;
  storyStrip.innerHTML = '';
}

        // optional: keep global progress ping
        // showStatus(data.surprise_ready? "üéÅ You‚Äôve hit 5! Your surprise is ready to export." : `üî• ${data.count}/5 done. ${data.remaining} to unlock your surprise.`,'success');
      }catch(e){
        setSubmitAnswer('‚ùå '+(e?.message||e),'error');
      }finally{
        show($('submitLoading'),false);
      }
    }

    function restoreMapIfHidden(){
      const mc = $('mapContainer');
      if (mc && mc.style.display !== 'none' && map) {
        setTimeout(() => {
          map.invalidateSize();

          // üß≠ Only re-pan if no task marker (avoid snapping back to blue pin)
          if (!taskMarker && currentLocation) {
            map.panTo([currentLocation.latitude, currentLocation.longitude]);
          }
        }, 500);
      }
    }


    window.onload=function(){
      ['photoBtn','videoBtn','audioBtn','textBtn'].forEach(id=>$(id).classList.add('locked'));
      show($('startPhotoBtn'),false); 
      show($('startVideoBtn'),false); 
      show($('startAudioBtn'),false); s
      how($('textSection'),false);
      $('newTaskAfterSubmit').style.display = 'none'; // ‚úÖ start hidden
      
      // ‚úÖ Force-hide story section before checking unlock state
      $('storySection').style.display = 'none';
      $('revealStoryBtn').style.display = 'none';
      
      initializeStoryProgress(); // renamed version
    };

    $('textInput').addEventListener('input',function(){
      let text=this.value;
      if(text.length>300){
        text=text.slice(0,300); this.value=text;
        showMediaError('You can write up to 300 characters only.');
      } else {
        clearMediaError();
      }
      textDraft=text; $('wordCount').textContent=`${text.length} / 300 characters`;
      const ab=$('actionButtons'); 
      if(text.length>0){ 
        show(ab, true);
        $('submitBtn').style.display = 'inline-block'; // ‚úÖ Re-show submit
        uploadedMedia = new Blob([text], { type: 'text/plain' });
      } else { show(ab,false); uploadedMedia=null; }
    });

    $('thumbUpBtn').addEventListener('click', () => {
      if (!currentTask?.task) return;
      sendFeedback('up', currentTask.prompt || '', currentTask.task);
      show($('feedbackButtons'), false);  // <-- HIDE BUTTONS AFTER VOTE
    });

    $('thumbDownBtn').addEventListener('click', () => {
      if (!currentTask?.task) return;
      show($('thumbDownReason'), true);
      show($('feedbackButtons'), false);  // <-- HIDE BUTTONS AFTER VOTE
    });

    $('submitFeedbackBtn').addEventListener('click', () => {
      const reason = $('feedbackReason').value || '';
      sendFeedback('down', currentTask.prompt || '', currentTask.task, reason);
      show($('thumbDownReason'), false);
      $('feedbackReason').value = '';
    });

    function sendFeedback(rating, input, output, reason = null) {
    fetch('/feedback', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ rating, input, output, reason })
    })
      .then(r => r.json())
      .then(data => {
        if (data.ok) {
          const s = $('feedbackStatus');
          s.textContent = "Thanks for your feedback!";
          s.className = "status success";
          show(s, true);
          setTimeout(() => show(s, false), 5000);
        } else {
          showStatus(data.error || "Feedback failed", "error");
        }
      })
      .catch(e => {
        showStatus("Error sending feedback: " + e.message, "error");
      });
  }

    // Wire up
    $('genNewTaskBtn').addEventListener('click', () => {
      $('newTaskAfterSubmit').style.display = 'none'; // hide while loading next task
      document.querySelector('#taskContainer h3')
        .scrollIntoView({ behavior: 'smooth', block: 'center' });
      setTimeout(() => generateTask(), 800);
    });
    $('newTaskBtn').addEventListener('click', () => {
      document.querySelector('#taskContainer h3')
        .scrollIntoView({ behavior: 'smooth', block: 'center' });
      setTimeout(() => generateTask(), 800);
    });
    $('downloadBtn').addEventListener('click',downloadMedia);
    $('submitBtn').addEventListener('click',submitMedia);
    $('deleteBtn').addEventListener('click',deleteMedia);
    $('startVideoBtn').addEventListener('click',startVideoRecording);
    $('stopVideoBtn').addEventListener('click',stopVideoRecording);
    $('startAudioBtn').addEventListener('click',startAudioRecording);
    $('stopAudioBtn').addEventListener('click',stopAudioRecording);
    $('photoBtn').addEventListener('click',()=>setMediaType('photo'));
    $('videoBtn').addEventListener('click',()=>setMediaType('video'));
    $('audioBtn').addEventListener('click',()=>setMediaType('audio'));
    $('textBtn').addEventListener('click',()=>setMediaType('text'));
    $('getLocationBtn').addEventListener('click',getLocation);
    
  
    getLocation();
    // Fullscreen image preview handler

function enableImageZoom() {
  const modal = document.getElementById('imageModal');
  const modalImg = document.getElementById('modalImage');
  const closeBtn = document.getElementById('closeModal');

  function attachZoom(img) {
    if (img.dataset.zoomBound) return; // prevent double binding
    img.dataset.zoomBound = "1";
    img.style.cursor = 'zoom-in';
    img.addEventListener('click', () => {
      modal.style.display = 'block';
      modalImg.src = img.src;
    });
  }

  // Attach to existing images
  document.querySelectorAll('#storyStrip img, #mediaPreview img').forEach(attachZoom);

  // Observe for new ones (after story unlock or photo submission)
  const observer = new MutationObserver(mutations => {
    mutations.forEach(mutation => {
      mutation.addedNodes.forEach(node => {
        if (node.tagName === 'IMG') attachZoom(node);
        else if (node.querySelectorAll) {
          node.querySelectorAll('img').forEach(attachZoom);
        }
      });
    });
  });

  observer.observe(document.body, { childList: true, subtree: true });

  // Close modal handlers
  closeBtn.onclick = () => modal.style.display = 'none';
  modal.onclick = (e) => {
    if (e.target === modal) modal.style.display = 'none';
  };
}

// ‚úÖ Initialize once window loads
window.addEventListener('load', enableImageZoom);
</script>

  <div id="imageModal" class="modal">
  <span id="closeModal">&times;</span>
  <img id="modalImage" src="" alt="Preview" />
  </div>
</body>
</html>
