<!-- /templates/index.html  (drop-in full file with requested changes) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hoppi - Your Adventure Awaits!</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Arial, sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:20px}
    .container{background:#fff;border-radius:20px;padding:40px;box-shadow:0 20px 40px rgba(0,0,0,.1);max-width:600px;width:100%;text-align:center}
    .logo{font-size:3em;font-weight:bold;color:#667eea;margin-bottom:10px}
    .subtitle{color:#666;margin-bottom:30px;font-size:1.2em}
    .location-info{background:#f8f9fa;padding:20px;border-radius:10px;margin:20px 0;display:none}
    .location-info h3{margin-bottom:15px;color:#333}
    #locationStatus{font-weight:bold;margin-bottom:10px}
    #getLocationBtn{background:#28a745;font-size:.9em;padding:10px 20px}
    #getLocationBtn:hover{background:#218838}
    .task-container{background:#e8f4fd;padding:25px;border-radius:15px;margin:20px 0;border-left:5px solid #667eea}
    .task-text{font-size:1.3em;color:#333;line-height:1.6;margin-bottom:20px}
    .upload-section{margin:30px 0}
    #photoCanvas{display:block;margin:10px auto;border-radius:10px;max-width:100%;max-height:300px;object-fit:cover;box-shadow:0 2px 10px rgba(0,0,0,.2)}
    .image-preview{max-width:100%;max-height:300px;border-radius:10px;margin:20px 0;display:none}
    .btn{background:#667eea;color:#fff;border:none;padding:15px 30px;border-radius:25px;font-size:1.1em;cursor:pointer;margin:10px;transition:all .3s ease;text-decoration:none;display:inline-block}
    .btn:hover{background:#5a6fd8;transform:translateY(-2px)}
    .btn:disabled{background:#ccc;cursor:not-allowed;transform:none}
    .btn-secondary{background:#6c757d}
    .btn-secondary:hover{background:#5a6268}
    .status{margin:20px 0;padding:15px;border-radius:10px;display:none}
    .inline-alert{margin:10px auto 15px;padding:10px 16px;border-radius:10px;max-width:90%;font-size:.95em;line-height:1.4;text-align:center}
    .inline-alert.error{background:#f8d7da;color:#842029;border:1px solid #f5c6cb}
    .inline-alert.success{background:#d1e7dd;color:#0f5132;border:1px solid #badbcc}
    .status.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .status.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
    .loading{display:none;position:relative;background:rgba(255,255,255,.85);backdrop-filter:blur(4px);border-radius:15px;text-align:center;padding:25px 0;margin:15px auto;box-shadow:0 4px 15px rgba(0,0,0,.1)}
    .loading .spinner,.spinner{margin:0 auto 10px;border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    #startPhotoBtn,#startVideoBtn,#startAudioBtn{display:none}
    button.locked{opacity:.5;pointer-events:auto;cursor:not-allowed}
    button.locked:hover{opacity:.7}
    .hidden{display:none!important}
    .controls{
        display:flex;
        justify-content:center;  /* center horizontally */
        align-items:center;
        gap:10px;
        flex-wrap:wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">🎯 Hoppi</div>
    <div class="subtitle">Turn the real world into your playground!</div>

    <div class="location-info" id="locationInfo">
      <h3>📍 Your Location</h3>
      <p id="locationStatus">⏳ Locating...</p>
      <div id="mapContainer" style="display:none">
        <p id="locationDescription" style="font-weight:bold;margin-bottom:10px;color:#333"></p>
        <div id="map" style="width:100%;height:300px;border-radius:10px;margin:10px 0"></div>
        <!-- distanceInfo removed by request -->
      </div>
      <button class="btn" id="getLocationBtn" style="margin-top:10px">📍 Get My Location</button>
      <div class="status" id="status"></div>
    </div>

    <div class="loading" id="locationLoading" style="display:none">
      <div class="spinner"></div><p>Detecting your location...</p>
    </div>

    <div class="task-container" id="taskContainer">
      <h3>🎉 Let’s See What the Universe Has for You!</h3>
      <div class="task-text" id="taskText"></div>
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p style="color:#667eea;font-weight:bold">Generating your adventure task...</p>
      </div>
      <button class="btn" id="newTaskBtn">Get New Task</button>
      <div id="taskStatus" class="status" style="display:none"></div>
    </div>

    <div class="upload-section" id="uploadSection">
      <h3>📸 Capture Your Moment</h3>
      <div id="captureAlert" class="inline-alert" style="display:none"></div>
      <div class="media-type-selector" style="margin:20px 0">
        <button class="btn btn-secondary" id="photoBtn">📷 Photo</button>
        <button class="btn btn-secondary" id="videoBtn">📹 Video</button>
        <button class="btn btn-secondary" id="audioBtn">🎤 Audio</button>
        <button class="btn btn-secondary" id="textBtn">📝 Text</button>
      </div>

      <p id="countdownTimer" style="font-size:1.2em;color:#667eea;font-weight:bold;display:none">⏳ 30s left</p>

      <div id="photoCaptureSection" style="display:block;text-align:center;margin:20px 0">
        <video id="photoPreview" autoplay playsinline muted width="100%" height="300" style="border-radius:10px;display:none;object-fit:cover"></video>
        <canvas id="photoCanvas" width="640" height="480" style="display:none;border-radius:10px;margin-top:10px;max-width:100%;max-height:300px;object-fit:cover"></canvas>
        <!-- Photo controls -->
            <div class="controls" style="margin-bottom: 15px;">
            <button class="btn" id="startPhotoBtn">📷 Start Photo</button>
            <button class="btn btn-secondary" id="capturePhotoBtn" style="display:none">📸 Capture</button>
            <button class="btn btn-secondary" id="closePhotoBtn" style="display:none">⏹️ Stop</button>
            </div>
        </div>

      <input type="file" id="mediaInput" style="display:none">

      <div id="videoSection" style="display:none;text-align:center;margin:20px 0">
        <div class="controls" style="margin-bottom:15px;">
            <button class="btn" id="startVideoBtn">🎬 Start Recording</button>
            <button class="btn btn-secondary" id="stopVideoBtn" style="display:none">⏹️ Stop Recording</button>
        </div>
        <video id="videoPreview" width="100%" height="300" autoplay playsinline muted style="border-radius:10px;display:none"></video>
        </div>

      <div id="audioSection" style="display:none">
        <div class="controls" style="text-align:center;margin:20px 0;">
            <button class="btn" id="startAudioBtn">🎤 Start Recording</button>
            <button class="btn btn-secondary" id="stopAudioBtn" style="display:none">⏹️ Stop Recording</button>
        </div>
        <audio id="audioPreview" controls style="width:100%;margin:10px 0;display:none"></audio>
        </div>

      <div id="textSection" style="display:none;text-align:center;margin:20px 0">
        <textarea id="textInput" placeholder="Write your thoughts here (max 300 characters)..." rows="6" style="width:100%;border-radius:10px;padding:10px;border:1px solid #ccc"></textarea>
        <p id="wordCount" style="color:#666;margin-top:5px">0 / 300 characters</p>
      </div>

      <div id="mediaPreview"></div>
      <div id="actionButtons" style="display:none">
        <button class="btn btn-secondary" id="deleteBtn">🗑 Delete</button>
        <button class="btn" id="submitBtn">📤 Submit</button>
        <button class="btn btn-secondary" id="downloadBtn">💾 Download</button>
      </div>
    </div>
  </div>

  <script>
    // --- state ---
    let currentLocation=null,currentTask=null,uploadedMedia=null,currentMediaType='photo';
    let mediaRecorder=null,recordedChunks=[],videoStream=null,audioStream=null,photoStream=null;
    let map=null,locationMarker=null,suppressOnStop=false,countdownInterval=null,videoTimer=null,audioTimer=null;
    let countdownSeconds=30,textDraft=''; let taskAborter=null;
    let taskMarker=null; // distance line removed

    // UI helpers
    const $ = id => document.getElementById(id);
    const show = (el,flag) => el.style.display = flag ? 'block' : 'none';

    function startCountdown(duration=30){
      const t=$('countdownTimer'); countdownSeconds=duration; t.textContent=`⏳ ${countdownSeconds}s left`; show(t,true);
      clearInterval(countdownInterval);
      countdownInterval=setInterval(()=>{ countdownSeconds--;
        if(countdownSeconds>0){ t.textContent=`⏳ ${countdownSeconds}s left`; }
        else{ stopCountdown(); t.textContent='✅ Done!'; setTimeout(()=>show(t,false),1500); }
      },1000);
    }
    function stopCountdown(){ clearInterval(countdownInterval); show($('countdownTimer'),false); }

    function resetCapture(isSwitching=true){
      const wasRecording = mediaRecorder && mediaRecorder.state==='recording';
      suppressOnStop = isSwitching && wasRecording;
      if(wasRecording){ try{ mediaRecorder.stop(); }catch{} }
      [videoStream,audioStream,photoStream].forEach(s=>{ if(s){ s.getTracks().forEach(t=>t.stop()); }});
      videoStream=audioStream=photoStream=null;
      ['photoPreview','photoCanvas','videoPreview','audioPreview'].forEach(id=>{ const el=$(id); if(el) show(el,false);});
      ['capturePhotoBtn','closePhotoBtn','stopVideoBtn','stopAudioBtn'].forEach(id=>{ const el=$(id); if(el) show(el,false);});
      if(isSwitching){ $('mediaPreview').innerHTML=''; show($('actionButtons'),false); uploadedMedia=null; }
      stopCountdown();
      clearTimeout(videoTimer); clearTimeout(audioTimer);
    }

    const blueIcon = new L.Icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
      shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});
    const redIcon = new L.Icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
      shadowUrl:'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});

    function getLocation(){
      const status=$('locationStatus'), info=$('locationInfo');
      if(!navigator.geolocation){ status.textContent="❌ Geolocation is not supported by this browser."; showStatus('Geolocation is not supported by this browser.','error'); return;}
      status.textContent="⏳ Locating..."; info.style.display='block';
      navigator.geolocation.getCurrentPosition(pos=>{
        currentLocation={latitude:pos.coords.latitude,longitude:pos.coords.longitude,accuracy:pos.coords.accuracy};
        status.style.display='none'; showMapAndLocation(); showStatus('Location detected successfully!','success');
      },err=>{
        const msgs={1:'Permission denied.',2:'Position unavailable.',3:'Request timed out.'};
        const msg=`❌ Unable to detect location. ${msgs[err.code]||'Unknown error.'}`;
        status.textContent=msg; status.style.display='block'; showStatus(msg,'error');
      },{enableHighAccuracy:true,timeout:10000,maximumAge:300000});
    }

    function showMapAndLocation(){
      const mapContainer=$('mapContainer'); mapContainer.style.display='block';
      if(map) map.remove();

      // create map first
      map=L.map('map').setView([currentLocation.latitude,currentLocation.longitude],15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap contributors'}).addTo(map);
      locationMarker=L.marker([currentLocation.latitude,currentLocation.longitude],{icon:blueIcon}).addTo(map);
      getLocationDescription();

      setTimeout(() => {
        if(!map) return;
        map.invalidateSize();
        map.panTo([currentLocation.latitude,currentLocation.longitude]);
        // re-render existing task target
        if (currentTask && currentTask.selected_place &&
            currentTask.selected_place.lat != null && currentTask.selected_place.lon != null) {
          renderTaskTarget(currentTask.selected_place);
        }
      }, 500);
    }

    async function getLocationDescription(){
      try{
        const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${currentLocation.latitude}&lon=${currentLocation.longitude}&addressdetails=1`,{headers:{'User-Agent':'hoppi-app'}});
        const data=await r.json();
        let description="Hey, you're somewhere interesting! What are you up to?";
        let popup=`📍 You are at ${currentLocation.latitude.toFixed(4)}, ${currentLocation.longitude.toFixed(4)}`;
        if(data && data.address){
          const a=data.address;
          const road=a.road||a.pedestrian||a.path||null;
          const neighborhood=a.neighbourhood||a.suburb||a.city||a.town||a.village||null;
          const type = (()=>{
            const fields=[a.amenity,a.leisure,a.shop,a.tourism,a.highway,a.office,a.building,a.natural,a.landuse].filter(Boolean).map(v=>v.toLowerCase());
            const has=k=>fields.includes(k);
            if(['park','garden','playground','trail','forest','woodland'].some(has)) return 'park';
            if(['museum','gallery','exhibition'].some(has)) return 'museum';
            if(['restaurant','cafe','bar'].some(has)) return 'restaurant';
            if(['mall','shopping','market','retail','store','shop'].some(has)) return 'mall';
            return null;
          })();
          if(type){ description=`Hey, you are in a ${type}. What are you up to?`; popup=`📍 You are in a ${type}`; }
          else if(road){ description=`Hey, you are on ${road}. What are you up to?`; popup=`📍 You are on ${road}`; }
          else if(neighborhood){ description=`Hey, you are near ${neighborhood}. What are you up to?`; popup=`📍 You are near ${neighborhood}`; }
        }
        $('locationDescription').textContent=description;
        if(locationMarker){ locationMarker.bindPopup(popup).openPopup(); }
      }catch{
        $('locationDescription').textContent="📍 Hey, you are here! What are you up to?";
        if(locationMarker){ locationMarker.bindPopup("📍 You are here!").openPopup(); }
      }
    }

    // 🔸 emoji label for task place
    function getCategoryEmoji(cat){
      const c=(cat||'').toLowerCase();
      if(c.includes('cafe')) return '☕';
      if(c.includes('restaurant')||c.includes('fast_food')||c.includes('food')) return '🍽️';
      if(c.includes('park')||c.includes('garden')||c.includes('playground')) return '🌳';
      if(c.includes('library')) return '📚';
      if(c.includes('mall')||c.includes('retail')||c.includes('market')) return '🏬';
      if(c.includes('supermarket')||c.includes('convenience')) return '🛒';
      if(c.includes('bar')||c.includes('pub')) return '🍺';
      if(c.includes('museum')||c.includes('gallery')) return '🏛️';
      if(c.includes('hotel')) return '🏨';
      if(c.includes('hospital')||c.includes('clinic')) return '🏥';
      if(c.includes('school')||c.includes('university')) return '🎓';
      return '📍';
    }

    function renderTaskTarget(place){
    if(!map || !place || place.lat == null || place.lon == null || !currentLocation) return;

    // clear previous task marker
    if (taskMarker) { map.removeLayer(taskMarker); taskMarker = null; }

    const userLL  = L.latLng(currentLocation.latitude, currentLocation.longitude);
    const placeLL = L.latLng(place.lat, place.lon);

    const emoji = (cat => {
      const c=(cat||'').toLowerCase();
      if(c.includes('cafe')) return '☕';
      if(c.includes('restaurant')||c.includes('fast_food')||c.includes('food')) return '🍽️';
      if(c.includes('park')||c.includes('garden')||c.includes('playground')) return '🌳';
      if(c.includes('library')) return '📚';
      if(c.includes('mall')||c.includes('retail')||c.includes('market')) return '🏬';
      if(c.includes('supermarket')||c.includes('convenience')) return '🛒';
      if(c.includes('bar')||c.includes('pub')) return '🍺';
      if(c.includes('museum')||c.includes('gallery')) return '🏛️';
      if(c.includes('hotel')) return '🏨';
      if(c.includes('hospital')||c.includes('clinic')) return '🏥';
      if(c.includes('school')||c.includes('university')) return '🎓';
      return '📍';
    })(place.category);

    const esc = s => String(s||'')
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;')
      .replace(/'/g,'&#039;');

    const name = esc(place.name || 'Task location');
    const gMaps = `https://www.google.com/maps?q=${place.lat},${place.lon}`;
    const aMaps = `https://maps.apple.com/?q=${place.lat},${place.lon}`;

    taskMarker = L.marker([place.lat, place.lon], { icon: redIcon })
      .addTo(map)
      .bindPopup(`
        <div style="font-weight:600;">${emoji} ${name}</div>
        <div style="font-size:12px;color:#555;margin-top:6px;">
          <a href="${gMaps}" target="_blank" rel="noopener">Open in Google Maps</a>
          &nbsp;·&nbsp;
          <a href="${aMaps}" target="_blank" rel="noopener">Apple Maps</a>
        </div>
      `, { autoClose:false, closeOnClick:false })
      .openPopup();

    // 👇 Show both pins (blue current + red task) in frame
    const bounds = L.latLngBounds([userLL, placeLL]);
    map.fitBounds(bounds, { padding: [30,30], maxZoom: 16 });
  }
    function clearTaskTarget(){
      if(taskMarker){ map && map.removeLayer(taskMarker); taskMarker=null; }
    }

    function escapeHtml(s=''){
  return String(s)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#039;');
}

function getCategoryEmoji(cat){
  const c=(cat||'').toLowerCase();
  if(c.includes('cafe')) return '☕';
  if(c.includes('restaurant')||c.includes('fast_food')||c.includes('food')) return '🍽️';
  if(c.includes('park')||c.includes('garden')||c.includes('playground')) return '🌳';
  if(c.includes('library')) return '📚';
  if(c.includes('mall')||c.includes('retail')||c.includes('market')) return '🏬';
  if(c.includes('supermarket')||c.includes('convenience')) return '🛒';
  if(c.includes('bar')||c.includes('pub')) return '🍺';
  if(c.includes('museum')||c.includes('gallery')) return '🏛️';
  if(c.includes('hotel')) return '🏨';
  if(c.includes('hospital')||c.includes('clinic')) return '🏥';
  if(c.includes('school')||c.includes('university')) return '🎓';
  return '📍';
}

function clearTaskTarget(){
  if(taskMarker){ map && map.removeLayer(taskMarker); taskMarker=null; }
}

function renderTaskTarget(place){
  if(!map || !place || place.lat==null || place.lon==null || !currentLocation) return;
  clearTaskTarget();

  const userLL  = L.latLng(currentLocation.latitude, currentLocation.longitude);
  const placeLL = L.latLng(place.lat, place.lon);

  const emoji = getCategoryEmoji(place.category);
  const name  = place.name || 'Task location';
  const label = `${emoji} ${escapeHtml(name)}`;

  // Build navigation links
  const gMaps = `https://www.google.com/maps?q=${place.lat},${place.lon}`;
  const aMaps = `https://maps.apple.com/?q=${place.lat},${place.lon}`;

  taskMarker = L.marker([place.lat, place.lon], { icon: redIcon })
    .addTo(map)
    .bindPopup(
      `
      <div style="font-weight:600;">${label}</div>
      <div style="font-size:12px;color:#555;margin-top:6px;">
        <a href="${gMaps}" target="_blank" rel="noopener">Open in Google Maps</a>
        &nbsp;·&nbsp;
        <a href="${aMaps}" target="_blank" rel="noopener">Apple Maps</a>
      </div>
      `,
      { autoClose:false, closeOnClick:false }
    )
    .openPopup();

  // Show both pins nicely
  const bounds = L.latLngBounds([userLL, placeLL]).pad(0.25);
  map.fitBounds(bounds);
}

    async function generateTask(){
      if(!currentLocation){ showStatus('📍 Please allow location first before generating a task.','error'); return; }
      if(taskAborter) taskAborter.abort();
      taskAborter = new AbortController();
      showLoading(true);
      try{
        const res=await fetch('/generate-task',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(currentLocation),signal:taskAborter.signal});
        const data=await res.json();
        if(res.ok){
          currentTask=data;
          if (data && data.selected_place && data.selected_place.lat != null && data.selected_place.lon != null) {
            renderTaskTarget(data.selected_place);
          } else {
            clearTaskTarget();
          }
          ['photoBtn','videoBtn','audioBtn','textBtn'].forEach(id=>$(id).classList.remove('locked'));
          currentMediaType='photo';
          show($('photoCaptureSection'),true); show($('startPhotoBtn'),true);
          show($('videoSection'),false); show($('audioSection'),false); show($('textSection'),false);
          $('photoBtn').className='btn'; $('videoBtn').className='btn btn-secondary'; $('audioBtn').className='btn btn-secondary'; $('textBtn').className='btn btn-secondary';
          clearCaptureAlert(); $('taskText').textContent=data.task; show($('taskContainer'),true); show($('uploadSection'),true);
          showTaskStatus(`🎯 Task generated for ${data.location_type} location!`,'success'); $('uploadSection').scrollIntoView({behavior:'smooth',block:'center'}); restoreMapIfHidden();
        }else{ showStatus(data.error||'Failed to generate task','error'); }
      }catch(e){ if(e.name!=='AbortError') showStatus('Error generating task: '+e.message,'error'); }
      finally{ showLoading(false); }
    }

    function showLoading(showIt){
      const d=$('loading'), p=d.querySelector('p');
      const msgs=["🎲 Rolling the dice of destiny...","🌍 Finding your next adventure spot...","🧭 Calibrating your challenge compass...","🪄 Summoning your quest from the ether...","🚀 Brewing up something epic..."];
      if(showIt){ p.textContent=msgs[Math.floor(Math.random()*msgs.length)]; show(d,true); } else { show(d,false); restoreMapIfHidden(); }
    }
    function showStatus(message,type){ const s=$('status'); s.textContent=message; s.className=`status ${type}`; show(s,true); setTimeout(()=>show(s,false),5000); }
    function showTaskStatus(message,type){ const s=$('taskStatus'); s.textContent=message; s.className=`status ${type}`; show(s,true); setTimeout(()=>show(s,false),5000); }
    function showCaptureAlert(msg,type='error'){ const el=$('captureAlert'); el.className=`inline-alert ${type}`; el.textContent=msg; show(el,true); el.scrollIntoView({behavior:'smooth',block:'center'}); }
    function clearCaptureAlert(){ const el=$('captureAlert'); show(el,false); el.textContent=''; el.className='inline-alert'; }
    function checkTaskBeforeRecording(){ if(!currentTask||!currentTask.task){ showCaptureAlert('⚠️ Please generate a task before capturing your moment!'); return false;} clearCaptureAlert(); return true; }

    function setMediaType(type){
      currentMediaType=type;
      if(!currentTask||!currentTask.task){ showCaptureAlert('⚠️ Please generate a task before capturing your moment!','error');
        ['photoCaptureSection','videoSection','audioSection','textSection'].forEach(id=>show($(id),false)); return; }
      clearCaptureAlert();
      ['photo','video','audio','text'].forEach(bt=>{ $(`${bt}Btn`).className = (type===bt)?'btn':'btn btn-secondary';});
      ['photoCaptureSection','videoSection','audioSection','textSection'].forEach(id=>show($(id),false));
      resetCapture(true);
      if(type==='photo'){ show($('photoCaptureSection'),true); show($('startPhotoBtn'),true); }
      else if(type==='video'){ show($('videoSection'),true); show($('startVideoBtn'),true); }
      else if(type==='audio'){ show($('audioSection'),true); show($('startAudioBtn'),true); }
      else if(type==='text'){ show($('textSection'),true); restoreTextFromDraft(); }
      ['startPhotoBtn','startVideoBtn','startAudioBtn'].forEach(id=>{ if(type==='text') show($(id),false);});
      restoreMapIfHidden();
    }

    function restoreTextFromDraft(){
      const ta=$('textInput'), ab=$('actionButtons'), wc=$('wordCount');
      ta.value=textDraft; const len=textDraft.length; wc.textContent=`${Math.min(len,300)} / 300 characters`;
      if(len>0){ uploadedMedia=new Blob([textDraft],{type:'text/plain'}); show(ab,true);} else { uploadedMedia=null; show(ab,false); }
    }

    function setupMediaUpload(){ /* reserved for manual uploads */ }

    function safeRecorder(stream, fallbackTypes){
      for(const t of fallbackTypes){ if(MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(t)){ try{ return new MediaRecorder(stream,{mimeType:t}); }catch{} } }
      try{ return new MediaRecorder(stream); }catch{ return new MediaRecorder(stream); }
    }

    async function startVideoRecording(){
      if(!checkTaskBeforeRecording()) return;
      suppressOnStop=false; recordedChunks=[]; $('mediaPreview').innerHTML=''; show($('actionButtons'),false);
      try{
        videoStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
        const vp=$('videoPreview'); vp.srcObject=videoStream; show(vp,true);
        mediaRecorder = safeRecorder(videoStream, ['video/webm;codecs=vp9,opus','video/webm;codecs=vp8,opus','video/mp4']);
        mediaRecorder.ondataavailable=e=>{ if(e.data.size>0) recordedChunks.push(e.data); };
        mediaRecorder.onstop=()=>{ if(suppressOnStop){suppressOnStop=false;return;}
          const blob=new Blob(recordedChunks,{type: recordedChunks[0]?.type || 'video/webm'}); if(blob.size===0) return;
          const url=URL.createObjectURL(blob);
          const v=document.createElement('video'); v.src=url; v.controls=true; v.style.width='100%'; v.style.maxHeight='300px'; v.style.borderRadius='10px';
          const mp=$('mediaPreview'); mp.innerHTML=''; mp.appendChild(v); show($('actionButtons'),true); uploadedMedia=blob; showStatus('🎬 Video recorded!','success');
          setTimeout(()=>mp.scrollIntoView({behavior:'smooth',block:'center'}),300);
          v.onloadeddata=()=>URL.revokeObjectURL(url);
        };
        mediaRecorder.start(); startCountdown(30); show($('startVideoBtn'),false); show($('stopVideoBtn'),true); showStatus('🎥 Recording started (max 30s)...','success');
        videoTimer=setTimeout(()=>{ if(mediaRecorder&&mediaRecorder.state==='recording') stopVideoRecording(); },30000);
      }catch(e){ showStatus('❌ Error accessing camera: '+e.message,'error'); }
      finally{ restoreMapIfHidden(); }
    }
    function stopVideoRecording(){
      const vp=$('videoPreview');
      if(mediaRecorder && mediaRecorder.state==='recording'){ stopCountdown(); try{mediaRecorder.stop();}catch{} }
      if(videoStream){ videoStream.getTracks().forEach(t=>t.stop()); videoStream=null; }
      show(vp,false); show($('startVideoBtn'),true); show($('stopVideoBtn'),false);
    }

    async function startAudioRecording(){
      if(!checkTaskBeforeRecording()) return;
      suppressOnStop=false; recordedChunks=[]; $('mediaPreview').innerHTML=''; show($('actionButtons'),false);
      try{
        audioStream=await navigator.mediaDevices.getUserMedia({audio:true});
        mediaRecorder = safeRecorder(audioStream, ['audio/webm;codecs=opus','audio/ogg;codecs=opus']);
        mediaRecorder.ondataavailable=e=>{ if(e.data.size>0) recordedChunks.push(e.data); };
        mediaRecorder.onstop=()=>{ if(suppressOnStop){suppressOnStop=false;return;}
          const blob=new Blob(recordedChunks,{type: recordedChunks[0]?.type || 'audio/webm'}); if(blob.size===0) return;
          const url=URL.createObjectURL(blob);
          const a=document.createElement('audio'); a.src=url; a.controls=true; a.style.width='100%';
          const mp=$('mediaPreview'); mp.innerHTML=''; mp.appendChild(a); show($('actionButtons'),true); uploadedMedia=blob; showStatus('🎧 Audio recorded!','success');
          setTimeout(()=>mp.scrollIntoView({behavior:'smooth',block:'center'}),300);
          a.onloadeddata=()=>URL.revokeObjectURL(url);
        };
        mediaRecorder.start(); startCountdown(30); show($('startAudioBtn'),false); show($('stopAudioBtn'),true); showStatus('🎙️ Recording started (max 30s)...','success');
        audioTimer=setTimeout(()=>{ if(mediaRecorder&&mediaRecorder.state==='recording') stopAudioRecording(); },30000);
      }catch(e){ showStatus('❌ Error accessing microphone: '+e.message,'error'); }
    }
    function stopAudioRecording(){
      if(mediaRecorder && mediaRecorder.state==='recording'){ stopCountdown(); try{mediaRecorder.stop();}catch{} }
      if(audioStream){ audioStream.getTracks().forEach(t=>t.stop()); audioStream=null; }
      show($('startAudioBtn'),true); show($('stopAudioBtn'),false);
    }

    function getTimestamp(){ const n=new Date(); const pad=n=>n.toString().padStart(2,'0'); return `${n.getFullYear()}-${pad(n.getMonth()+1)}-${pad(n.getDate())}_${pad(n.getHours())}-${pad(n.getMinutes())}-${pad(n.getSeconds())}`; }

    $('startPhotoBtn').addEventListener('click', async ()=>{
      if(!checkTaskBeforeRecording()) return;
      try{
        photoStream=await navigator.mediaDevices.getUserMedia({video:true});
        const v=$('photoPreview'); v.srcObject=photoStream; show(v,true); show($('photoCanvas'),false);
        show($('startPhotoBtn'),false); show($('capturePhotoBtn'),true); show($('closePhotoBtn'),true);
        showStatus('Camera ready! Tap 📸 Capture to take a photo.','success'); v.scrollIntoView({behavior:'smooth',block:'center'});
      }catch(err){ showStatus('❌ Unable to access camera: '+err.message,'error'); } finally{ restoreMapIfHidden(); }
    });

    $('capturePhotoBtn').addEventListener('click', ()=>{
      const v=$('photoPreview'), c=$('photoCanvas'), ctx=c.getContext('2d');
      const r=v.getBoundingClientRect(); c.width=r.width; c.height=r.height;
      const av=v.videoWidth/v.videoHeight, ad=r.width/r.height;
      let sx=0,sy=0,sw=v.videoWidth,sh=v.videoHeight;
      if(av>ad){ const nw=v.videoHeight*ad; sx=(v.videoWidth-nw)/2; sw=nw; } else if(av<ad){ const nh=v.videoWidth/ad; sy=(v.videoHeight-nh)/2; sh=nh; }
      ctx.drawImage(v,sx,sy,sw,sh,0,0,c.width,c.height);
      if(photoStream){ photoStream.getTracks().forEach(t=>t.stop()); photoStream=null; }
      show(v,false); show($('capturePhotoBtn'),false); show($('closePhotoBtn'),false);
      c.toBlob(blob=>{
        uploadedMedia=blob;
        const url=URL.createObjectURL(blob);
        const img=new Image(); img.src=url; img.style.display='block'; img.style.margin='10px auto'; img.style.borderRadius='10px'; img.style.maxWidth='100%'; img.style.maxHeight='300px'; img.style.boxShadow='0 2px 10px rgba(0,0,0,.2)';
        const mp=$('mediaPreview'); mp.innerHTML=''; mp.appendChild(img); show($('actionButtons'),true); showStatus('📸 Photo captured! You can download or delete it.','success');
        setTimeout(()=>mp.scrollIntoView({behavior:'smooth',block:'center'}),300);
        img.onload=()=>URL.revokeObjectURL(url);
      },'image/jpeg');
    });

    $('closePhotoBtn').addEventListener('click', ()=>{
      if(photoStream){ photoStream.getTracks().forEach(t=>t.stop()); photoStream=null; }
      show($('photoPreview'),false); show($('photoCanvas'),false); show($('startPhotoBtn'),true); show($('capturePhotoBtn'),false); show($('closePhotoBtn'),false);
      showStatus('Camera stopped.','success'); restoreMapIfHidden();
    });

    function downloadMedia(){
      if(!uploadedMedia) return;
      const link=document.createElement('a');
      let extMap={photo:'jpg',video:'webm',audio:'webm',text:'txt'};
      const ext=extMap[currentMediaType]||'dat';
      const url=URL.createObjectURL(uploadedMedia);
      link.href=url; link.download=`hoppi-${currentMediaType}-${getTimestamp()}.${ext}`;
      document.body.appendChild(link); link.click(); document.body.removeChild(link);
      setTimeout(()=>URL.revokeObjectURL(url),0);
      showStatus(`${currentMediaType[0].toUpperCase()+currentMediaType.slice(1)} downloaded successfully!`,'success');
    }

    function deleteMedia(){
      const mp=$('mediaPreview'), ab=$('actionButtons'), mi=$('mediaInput');
      mp.innerHTML=''; show(ab,false); uploadedMedia=null; if(mi) mi.value='';
      if(currentMediaType==='photo'){ show($('photoPreview'),false); show($('photoCanvas'),false); show($('startPhotoBtn'),true); show($('capturePhotoBtn'),false); show($('closePhotoBtn'),false); }
      else if(currentMediaType==='video'){ show($('videoPreview'),false); show($('startVideoBtn'),true); show($('stopVideoBtn'),false); }
      else if(currentMediaType==='audio'){ show($('audioPreview'),false); show($('startAudioBtn'),true); show($('stopAudioBtn'),false); }
      else if(currentMediaType==='text'){ textDraft=''; $('textInput').value=''; $('wordCount').textContent='0 / 300 characters'; }
      showStatus('🗑 Media deleted successfully.','success');
    }

    // Submit with judge (expects /submit backend)
    function getOrCreateSessionId(){
      const KEY='hoppi_session_id'; let id=localStorage.getItem(KEY);
      if(!id){ id=([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16)); localStorage.setItem(KEY,id);}
      return id;
    }
    async function submitMedia(){
      if(!currentTask||!currentTask.task){ showCaptureAlert('⚠️ Please generate a task before submitting!','error'); return; }
      const fd=new FormData();
      fd.append('session_id',getOrCreateSessionId());
      fd.append('task',currentTask.task);
      fd.append('media_type',currentMediaType);
      if(currentLocation){ fd.append('lat',String(currentLocation.latitude)); fd.append('lon',String(currentLocation.longitude)); }
      if(currentMediaType==='text'){ fd.append('text',typeof textDraft==='string'?textDraft:$('textInput').value||''); }
      else{
        if(!uploadedMedia){ showCaptureAlert('⚠️ Record or upload something first.','error'); return; }
        const ext=currentMediaType==='photo'?'jpg':'webm';
        const file=new File([uploadedMedia],`submission-${getTimestamp()}.${ext}`,{type: uploadedMedia.type || (currentMediaType==='photo'?'image/jpeg':'video/webm')});
        fd.append('file',file);
      }
      const loading=$('loading'); loading.querySelector('p').textContent="🧠 Letting Hoppi judge your masterpiece..."; show(loading,true);
      try{
        const res=await fetch('/submit',{method:'POST',body:fd});
        const data=await res.json();
        if(!res.ok||!data.ok){ throw new Error(data.error||'Submit failed'); }
        showTaskStatus(data.judge_text,'success');
        showStatus(data.surprise_ready? "🎁 You’ve hit 5! Your surprise is ready to export." : `🔥 ${data.count}/5 done. ${data.remaining} to unlock your surprise.`,'success');
      }catch(e){ showStatus('❌ '+e.message,'error'); }
      finally{ show(loading,false); }
    }

    function restoreMapIfHidden(){
      const mc=$('mapContainer');
      if(mc && mc.style.display!=='none' && map){
        setTimeout(()=>{ map.invalidateSize(); map.panTo([currentLocation.latitude,currentLocation.longitude]); },500);
      }
    }

    window.onload=function(){
      ['photoBtn','videoBtn','audioBtn','textBtn'].forEach(id=>$(id).classList.add('locked'));
      show($('startPhotoBtn'),false); show($('startVideoBtn'),false); show($('startAudioBtn'),false); show($('textSection'),false);
    };

    $('textInput').addEventListener('input',function(){
      let text=this.value; if(text.length>300){ text=text.slice(0,300); this.value=text; showStatus('⚠️ You can write up to 300 characters only.','error'); }
      textDraft=text; $('wordCount').textContent=`${text.length} / 300 characters`;
      const ab=$('actionButtons'); if(text.length>0){ show(ab,true); uploadedMedia=new Blob([text],{type:'text/plain'});} else { show(ab,false); uploadedMedia=null; }
    });

    $('newTaskBtn').addEventListener('click',generateTask);
    $('downloadBtn').addEventListener('click',downloadMedia);
    $('submitBtn').addEventListener('click',submitMedia);
    $('deleteBtn').addEventListener('click',deleteMedia);
    $('startVideoBtn').addEventListener('click',startVideoRecording);
    $('stopVideoBtn').addEventListener('click',stopVideoRecording);
    $('startAudioBtn').addEventListener('click',startAudioRecording);
    $('stopAudioBtn').addEventListener('click',stopAudioRecording);
    $('photoBtn').addEventListener('click',()=>setMediaType('photo'));
    $('videoBtn').addEventListener('click',()=>setMediaType('video'));
    $('audioBtn').addEventListener('click',()=>setMediaType('audio'));
    $('textBtn').addEventListener('click',()=>setMediaType('text'));
    $('getLocationBtn').addEventListener('click',getLocation);

    getLocation();
  </script>
</body>
</html>
